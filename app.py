import streamlit as st
import pandas as pd
import google.generativeai as genai

# рзз. ржЧрзБржЧрж▓ ржПржЖржЗ рж╕рзЗржЯржЖржк
try:
    api_key = st.secrets["GOOGLE_API_KEY"]
    genai.configure(api_key=api_key)
except:
    st.error("API Key ржЦрзБржБржЬрзЗ ржкрж╛ржУрзЯрж╛ ржпрж╛рзЯржирж┐! Streamlit Settings-ржП ржПржЯрж┐ ржпрзЛржЧ ржХрж░рзБржиред")

# ржоржбрзЗрж▓ рж╕рзЗржЯржЖржк (NotFound ржПрж░рж░ ржПрзЬрж╛рждрзЗ ржПржЗ ржлрж░ржорзНржпрж╛ржЯржЯрж┐ ржирж┐рж░рж╛ржкржж)
model = genai.GenerativeModel('gemini-1.5-flash')

# рзи. ржЖржкржирж╛рж░ ржмрж┐рж╢рзЗрж╖ ржлрж░ржорзНржпрж╛ржЯрзЗрж░ ржлрж╛ржЗрж▓ржЯрж┐ ржкрзЬрж╛рж░ рж▓ржЬрж┐ржХ
@st.cache_data
def load_data():
    with open('books.csv', 'r', encoding='utf-8') as f:
        lines = f.readlines()
    
    books = []
    for i in range(len(lines)):
        line = lines[i].strip()
        # ржпржжрж┐ ржХрзЛржирзЛ рж▓рж╛ржЗржи http ржжрж┐рзЯрзЗ рж╢рзБрж░рзБ рж╣рзЯ, рждржмрзЗ рждрж╛рж░ ржЖржЧрзЗрж░ рж▓рж╛ржЗржиржЯрж┐ рж╣рж▓рзЛ ржмржЗрзЯрзЗрж░ ржирж╛ржо
        if line.startswith('http'):
            title = lines[i-1].strip()
            books.append({'book_name': title, 'download_link': line})
    
    return pd.DataFrame(books)

df = load_data()

# рзй. ржЗржирзНржЯрж╛рж░ржлрзЗрж╕ ржбрж┐ржЬрж╛ржЗржи
st.set_page_config(page_title="ржЗрж╕рж▓рж╛ржорж┐ржХ рж▓рж╛ржЗржмрзНрж░рзЗрж░рж┐ ржмржЯ", page_icon="ЁЯУЪ")
st.title("ЁЯУЪ ржЗрж╕рж▓рж╛ржорж┐ржХ рж▓рж╛ржЗржмрзНрж░рзЗрж░рж┐ ржЪрзНржпрж╛ржЯржмржЯ")

user_query = st.text_input("ржмржЗрзЯрзЗрж░ ржирж╛ржо ржмрж╛ ржмрж┐рж╖рзЯ рж▓рж┐ржЦрзБржи:", placeholder="ржпрзЗржоржи: рж╕ржжржХрж╛рж░ ржлржпрзАрж▓ржд")

if user_query:
    # рж╕рж╛рж░рзНржЪ рж▓ржЬрж┐ржХ
    results = df[df['book_name'].str.contains(user_query, case=False, na=False)]
    
    if not results.empty:
        st.success(f"ржЖржкржирж╛рж░ ржЬржирзНржп {len(results)}ржЯрж┐ ржмржЗ ржкрж╛ржУрзЯрж╛ ржЧрзЗржЫрзЗ:")
        for index, row in results.iterrows():
            with st.expander(f"ЁЯУЦ {row['book_name']}"):
                st.write(f"ЁЯФЧ [ржмржЗржЯрж┐ ржбрж╛ржЙржирж▓рзЛржб ржХрж░рждрзЗ ржПржЦрж╛ржирзЗ ржХрзНрж▓рж┐ржХ ржХрж░рзБржи]({row['download_link']})")
                st.info("ржЙржкрж░рзЗ ржжрзЗржУрзЯрж╛ рж▓рж┐ржВржХрзЗ ржХрзНрж▓рж┐ржХ ржХрж░рзЗ ржЕржирж▓рж╛ржЗржирзЗ ржкрзЬрждрзЗ ржмрж╛ ржбрж╛ржЙржирж▓рзЛржб ржХрж░рждрзЗ ржкрж╛рж░ржмрзЗржиред")
    else:
        # ржпржжрж┐ рж▓рж┐рж╕рзНржЯрзЗ ржирж╛ ржкрж╛ржУрзЯрж╛ ржпрж╛рзЯ, рждржмрзЗ Gemini AI ржЙрждрзНрждрж░ ржжрж┐ржмрзЗ
        with st.spinner("ржПржЖржЗ ржЙрждрзНрждрж░ ржЦрзБржБржЬржЫрзЗ..."):
            try:
                prompt = f"ржЗржЙржЬрж╛рж░ '{user_query}' ржирж╛ржорзЗрж░ ржПржХржЯрж┐ ржмржЗ ржЦрзБржБржЬржЫрзЗ ржпрж╛ ржЖржорж╛ржжрзЗрж░ рждрж╛рж▓рж┐ржХрж╛рзЯ ржирзЗржЗред рждрж╛ржХрзЗ ржЦрзБржм рж╕ржВржХрзНрж╖рзЗржкрзЗ ржПржмржВ ржиржорзНрж░ржнрж╛ржмрзЗ ржмрж╛ржВрж▓рж╛рзЯ ржЬрж╛ржирж╛ржУ ржпрзЗ ржПржЗ ржмржЗржЯрж┐ ржмрж░рзНрждржорж╛ржирзЗ ржЖржорж╛ржжрзЗрж░ рж╕ржВржЧрзНрж░рж╣рзЗ ржирзЗржЗред"
                response = model.generate_content(prompt)
                st.info(response.text)
            except Exception as e:
                st.error("ржжрзБржГржЦрж┐ржд, ржПржЖржЗ ржПржЗ ржорзБрж╣рзВрж░рзНрждрзЗ ржЙрждрзНрждрж░ ржжрж┐рждрзЗ ржкрж╛рж░ржЫрзЗ ржирж╛ред рждржмрзЗ ржЖржкржирж╛рж░ ржмржЗржЯрж┐ ржЖржорж╛ржжрзЗрж░ рждрж╛рж▓рж┐ржХрж╛рзЯ ржирзЗржЗред")

st.divider()
st.caption("Powered by Google Gemini AI | Islamic Library Bot")
