import streamlit as st
import pandas as pd
import google.generativeai as genai

# рзз. ржЧрзБржЧрж▓ ржПржЖржЗ рж╕рзЗржЯржЖржк
try:
    api_key = st.secrets["GOOGLE_API_KEY"]
    genai.configure(api_key=api_key)
except:
    st.error("API Key ржЦрзБржБржЬрзЗ ржкрж╛ржУрзЯрж╛ ржпрж╛рзЯржирж┐!")

model = genai.GenerativeModel('gemini-1.5-flash')

# рзи. ржлрж╛ржЗрж▓ ржкрзЬрж╛рж░ рж▓ржЬрж┐ржХ (ржЖржкржирж╛рж░ ржУржЗ ржмрж┐рж╢рзЗрж╖ ржлрж░ржорзНржпрж╛ржЯ ржЕржирзБржпрж╛рзЯрзА)
@st.cache_data
def load_data():
    try:
        with open('books.csv', 'r', encoding='utf-8') as f:
            lines = f.readlines()
        books = []
        for i in range(len(lines)):
            line = lines[i].strip()
            if line.startswith('http'):
                title = lines[i-1].strip()
                books.append({'book_name': title, 'download_link': line})
        return pd.DataFrame(books)
    except:
        return pd.DataFrame(columns=['book_name', 'download_link'])

df = load_data()

# рзй. ржЗржирзНржЯрж╛рж░ржлрзЗрж╕ ржбрж┐ржЬрж╛ржЗржи
st.set_page_config(page_title="ржЗрж╕рж▓рж╛ржорж┐ржХ рж▓рж╛ржЗржмрзНрж░рзЗрж░рж┐ ржмржЯ", page_icon="ЁЯУЪ")
st.title("ЁЯУЪ ржЗрж╕рж▓рж╛ржорж┐ржХ рж▓рж╛ржЗржмрзНрж░рзЗрж░рж┐ ржЪрзНржпрж╛ржЯржмржЯ")
st.write("ржЖрж╕рж╕рж╛рж▓рж╛ржорзБ ржЖрж▓рж╛ржЗржХрзБржо! ржЖржорж╛ржжрзЗрж░ рж▓рж╛ржЗржмрзНрж░рзЗрж░рж┐рждрзЗ ржЖржкржирж╛ржХрзЗ рж╕рзНржмрж╛ржЧрждржоред")

user_query = st.text_input("ржПржЦрж╛ржирзЗ ржХрж┐ржЫрзБ рж▓рж┐ржЦрзБржи (ржмржЗрзЯрзЗрж░ ржирж╛ржо ржмрж╛ рж╢рзБржнрзЗржЪрзНржЫрж╛):", placeholder="ржпрзЗржоржи: ржЖрж╕рж╕рж╛рж▓рж╛ржорзБ ржЖрж▓рж╛ржЗржХрзБржо / ржирзЗржХрзАрж░ ржжрж╛ржУрзЯрж╛ржд")

if user_query:
    # ржкрзНрж░ржержорзЗ ржбрж╛ржЯрж╛ржмрзЗржЬрзЗ ржмржЗ ржЦрзЛржБржЬрж╛ рж╣ржмрзЗ
    search_words = user_query.split()
    results = df.copy()
    for word in search_words:
        results = results[results['book_name'].str.contains(word, case=False, na=False)]
    
    # ржпржжрж┐ ржмржЗ ржЦрзБржБржЬрзЗ ржкрж╛ржУрзЯрж╛ ржпрж╛рзЯ
    if not results.empty:
        st.success(f"ржЖржкржирж╛рж░ ржЬржирзНржп {len(results)}ржЯрж┐ ржмржЗ ржкрж╛ржУрзЯрж╛ ржЧрзЗржЫрзЗ:")
        for index, row in results.iterrows():
            with st.expander(f"ЁЯУЦ {row['book_name']}"):
                st.write(f"ЁЯФЧ [ржмржЗржЯрж┐ ржбрж╛ржЙржирж▓рзЛржб ржХрж░рждрзЗ ржПржЦрж╛ржирзЗ ржХрзНрж▓рж┐ржХ ржХрж░рзБржи]({row['download_link']})")
                st.info("рж▓рж┐ржВржХрзЗ ржХрзНрж▓рж┐ржХ ржХрж░рзЗ ржмржЗржЯрж┐ ржкрзЬрждрзЗ ржкрж╛рж░ржмрзЗржиред")
    
    # ржпржжрж┐ ржмржЗ ржЦрзБржБржЬрзЗ ржирж╛ ржкрж╛ржУрзЯрж╛ ржпрж╛рзЯ (рждржЦржи Gemini AI ржХржерж╛ ржмрж▓ржмрзЗ)
    else:
        with st.spinner("ржЕржкрзЗржХрзНрж╖рж╛ ржХрж░рзБржи..."):
            try:
                # ржПржЖржЗ-ржХрзЗ ржирж┐рж░рзНржжрзЗрж╢ ржжрзЗржУрзЯрж╛ рж╣ржЪрзНржЫрзЗ ржХрзАржнрж╛ржмрзЗ ржХржерж╛ ржмрж▓ржмрзЗ
                system_prompt = f"""
                рждрзБржорж┐ ржПржХржЬржи ржЕрждрзНржпржирзНржд ржиржорзНрж░ ржЗрж╕рж▓рж╛ржорж┐ржХ рж▓рж╛ржЗржмрзНрж░рзЗрж░рж┐ ржЕрзНржпрж╛рж╕рж┐рж╕рзНржЯрзНржпрж╛ржирзНржЯред 
                ржЗржЙржЬрж╛рж░ рж▓рж┐ржЦрзЗржЫрзЗ: "{user_query}"
                
                ржирж┐рж░рзНржжрзЗрж╢ржирж╛:
                рзз. ржпржжрж┐ ржЗржЙржЬрж╛рж░ рж╕рж╛рж▓рж╛ржо ржжрзЗрзЯ (ржпрзЗржоржи: ржЖрж╕рж╕рж╛рж▓рж╛ржорзБ ржЖрж▓рж╛ржЗржХрзБржо), рждржмрзЗ ржУрзЯрж╛рж▓рж╛ржЗржХрзБржо ржЖрж╕рж╕рж╛рж▓рж╛ржо ржмрж▓рзЗ ржЙрждрзНрждрж░ ржжрж╛ржУ ржПржмржВ ржХрзЗржоржи ржЖржЫрзЗ ржЬрж┐ржЬрзНржЮрж╛рж╕рж╛ ржХрж░рзЛред
                рзи. ржпржжрж┐ ржЗржЙржЬрж╛рж░ рж╕рж╛ржзрж╛рж░ржг ржХржерж╛ ржмрж▓рзЗ (ржпрзЗржоржи: рж╣рж╛ржЗ, рж╣рзНржпрж╛рж▓рзЛ, ржХрзЗржоржи ржЖржЫрзЗржи), рждржмрзЗ ржмржирзНржзрзБрж╕рзБрж▓ржн ржЙрждрзНрждрж░ ржжрж╛ржУред
                рзй. ржЙрждрзНрждрж░рзЗрж░ рж╢рзЗрж╖рзЗ рж╕ржмрж╕ржорзЯ рждрж╛ржХрзЗ ржмрж▓рзЛ ржпрзЗ рж╕рзЗ ржпрзЗржи рждрж╛рж░ ржкрзНрж░рзЯрзЛржЬржирзАрзЯ ржЗрж╕рж▓рж╛ржорж┐ржХ ржмржЗрзЯрзЗрж░ ржирж╛ржо рж▓рж┐ржЦрзЗ рж╕рж╛рж░рзНржЪ ржХрж░рзЗред
                рзк. ржпржжрж┐ рж╕рзЗ ржПржоржи ржХрзЛржирзЛ ржмржЗ ржЦрзБржБржЬрзЗ ржпрж╛ ржЖржорж╛ржжрзЗрж░ рж▓рж┐рж╕рзНржЯрзЗ ржирзЗржЗ, рждржмрзЗ ржжрзБржГржЦ ржкрзНрж░ржХрж╛рж╢ ржХрж░рзЗ ржмрж▓рзЛ ржпрзЗ ржмржЗржЯрж┐ ржмрж░рзНрждржорж╛ржирзЗ ржирзЗржЗ, рждржмрзЗ ржЕржирзНржп ржмржЗ рж╕рж╛рж░рзНржЪ ржХрж░рждрзЗ ржмрж▓рзЛред
                рзл. рж╕ржмрж╕ржорзЯ ржмрж╛ржВрж▓рж╛ ржнрж╛рж╖рж╛рзЯ ржЙрждрзНрждрж░ ржжрж╛ржУред
                """
                
                response = model.generate_content(system_prompt)
                st.chat_message("assistant").write(response.text)
            except:
                st.error("ржжрзБржГржЦрж┐ржд, ржЖржорж┐ ржПржЗ ржорзБрж╣рзВрж░рзНрждрзЗ ржЙрждрзНрждрж░ ржжрж┐рждрзЗ ржкрж╛рж░ржЫрж┐ ржирж╛ред ржЕржирзБржЧрзНрж░рж╣ ржХрж░рзЗ ржмржЗрзЯрзЗрж░ ржирж╛ржо рж▓рж┐ржЦрзЗ рж╕рж╛рж░рзНржЪ ржХрж░рзБржиред")
                
st.divider()
st.caption("Powered by Google Gemini AI | ржЖржкржирж╛рж░ рж╕рзЗржмрж╛рзЯ ржирж┐рзЯрзЛржЬрж┐ржд")
